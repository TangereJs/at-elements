<link rel="import" href="../tangere/tangere.html">
<link rel="import" href="../at-doc-parser/at-doc-parser.html" />

<dom-module id="codemirror-hint-tag-attributes">
  <style>

  </style>
  <template>    
    <div>
      <template is="dom-repeat" items="{{catalog}}">
        <div>
          <span>"{{item.name}}": { attrs: [[_computeAttributesArrayString(item.properties)]] }[[_computeComma(index)]]</span>
        </div>
      </template>
    </div>
  </template>
  <script>
  'use strict';
  Polymer({
    is: 'codemirror-hint-tag-attributes',
    properties: {
      catalog: {
        type: Array,
        value: function() {
          return [];
        },
        notify: true
      }
    },
    ready: function() {
      var result = [];
      var currentGroup;
      var self = this;
      var registrations = Polymer.telemetry.registrations;
      var elementsToProcess = [];
      var processedElementCount = 0;

      function importElementText(elementName, valueChangedCallback, context) {
        var docParser = document.createElement('at-doc-parser');
        docParser.addEventListener('value-changed', valueChangedCallback.bind(context));
        var elementUrl = '../' + elementName + '/' + elementName + '.html';
        docParser.url = elementUrl;
      }

      function handleValueChanged(event) {
        processedElementCount += 1;
        var data = event.detail.value[0];
        result.push(data);
        // console.log('event.detail ' + JSON.stringify(data, null, " "));
        // console.log('Processed ' + processedElementCount + ' of ' + elementsToProcess.length);
        if (processedElementCount === elementsToProcess.length) {
          console.log('end of processing');
          
          result.sort(function(item1, item2) { 
            if (item1.name > item2.name) { 
              return 1;
            } else {
              return -1;
            }
          });

          self.catalog = result;
        }
      }

      registrations.forEach(function(registration, index) {
        var properties;
        var forResult;

        function isObject(obj) {
          return Object.prototype.toString.apply(obj) === "[object Object]";
        }

        function isArray(obj) {
          return Object.prototype.toString.apply(obj) === "[object Array]";
        }

        if (registration.is.startsWith("at-")) {
          elementsToProcess.push(registration.is);          
        }
      });

      elementsToProcess.forEach(function(elementName,  index){
        importElementText(elementName, handleValueChanged, self);
      });
    },

    _computeAttributesArrayString: function(properties) {
      var result = "";
      var separator = ", "

      function isArray(obj) {
        return Object.prototype.toString.apply(obj) === "[object Array]";
      }

      function isFunction(obj) {
        return Object.prototype.toString.apply(obj) === "[object Function]";
      }

      function isString(obj) {
        return Object.prototype.toString.apply(obj) === "[object String]";
      }

      function isObject(obj) {
        return Object.prototype.toString.apply(obj) === "[object Object]";
      }
 
      function escapeDoubleQuotes(str) {
        return str.replace(/\\([\s\S])|(")/g,"\\$1$2");
      }

      function isWindow(obj) {
        return Object.prototype.toString.apply(obj) === "[object Window]";
      }

      result += "{"

      properties.forEach(function(property, index) {
        var attrName = Polymer.CaseMap.camelToDashCase(property.name);
        var attrDescriptor = {
          description: property.description,
          type: property.type,
          value: property.possibleValues ? property.possibleValues.split(", ") : null
        }

        var attrValue = property.default;

        if (attrName.indexOf("-") > -1) {
          attrName = "\"" + attrName + "\"";
        }

        result += attrName + ": " + JSON.stringify(attrDescriptor);

        if (index < properties.length - 1) {
          result += separator;
        }
      });

      if (result.endsWith(", ")) {
        result = result.slice(0, result.length - 2);
      }

      result += "}";

      return result;
    },

    _computeComma: function(index) {
      if (index < this.catalog.length - 1) {
        return ",";
      } else {
        return "";
      }
    },

    _mergeObjects(dest, src) {

      Object.keys(src).forEach(function(key, index) {
        dest[key] = src[key];
      });

      return dest;
    }
  });
  </script>
</dom-module>
